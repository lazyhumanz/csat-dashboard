<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dynamic CSAT Dashboard</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #ec4899;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --bg-main: #020617;
        --bg-card: rgba(15, 23, 42, 0.96);
        --bg-card-soft: rgba(15, 23, 42, 0.8);
        --text-primary: #e5e7eb;
        --text-secondary: #9ca3af;
        --border-color: rgba(148, 163, 184, 0.28);
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top left, #1e293b 0, #020617 45%),
          radial-gradient(circle at bottom right, #4c1d95 0, #020617 55%);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px 24px 24px;
      }

      .container { max-width: 1380px; margin: 0 auto; }

      h2 {
        font-size: 30px;
        font-weight: 700;
        margin-bottom: 18px;
        background: linear-gradient(135deg, #6366f1 0%, #ec4899 40%, #22d3ee 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: 0.05em;
      }

      .filters {
        margin-bottom: 20px;
        padding: 16px 18px;
        border-radius: 18px;
        border: 1px solid var(--border-color);
        background: radial-gradient(circle at top left, #111827 0%, #020617 55%);
        background-color: var(--bg-card-soft);
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.9);
        display: flex;
        flex-wrap: wrap;
        gap: 16px 22px;
        align-items: flex-end;
      }

      .filters-left {
        flex: 1 1 0;
        display: grid;
        grid-template-columns: repeat(4, minmax(160px, 1fr));
        gap: 12px 18px;
        align-items: flex-end;
      }

      .filter-field { display: flex; flex-direction: column; gap: 6px; }
      .filter-field--wide { grid-column: 1 / -1; }

      .filters-right {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        min-width: 190px;
      }

      .filters label {
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .filters input[type="date"],
      .filters select {
        padding: 8px 11px;
        border-radius: 9px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.96);
        color: var(--text-primary);
        font-size: 13px;
        outline: none;
        min-height: 36px;
        transition: border-color 0.18s ease, box-shadow 0.18s ease,
          background 0.18s ease, transform 0.08s ease;
      }

      .filters input[type="date"]:focus,
      .filters select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.5);
        background: #020617;
        transform: translateY(-1px);
      }

      .filters button {
        padding: 9px 26px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        color: white;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 40%,
          #22d3ee 100%
        );
        box-shadow: 0 12px 30px rgba(79, 70, 229, 0.6);
        transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.2s;
        white-space: nowrap;
      }

      .filters button:hover:not(:disabled) {
        transform: translateY(-1.5px);
        box-shadow: 0 18px 42px rgba(79, 70, 229, 0.75);
      }

      .filters button:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 10px 24px rgba(79, 70, 229, 0.6);
      }

      .filters button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      #statusMessage {
        font-size: 12px;
        font-weight: 600;
        padding: 5px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(148, 163, 184, 0.36);
        min-height: 24px;
        max-width: 260px;
        text-align: right;
      }

      .kpi-row {
        display: grid;
        grid-template-columns: repeat(3, minmax(210px, 1fr));
        gap: 18px;
        margin-bottom: 20px;
      }

      .kpi-card {
        position: relative;
        padding: 16px 18px;
        border-radius: 18px;
        background: radial-gradient(circle at top left, #0b1120 0, #020617 55%);
        border: 1px solid rgba(148, 163, 184, 0.32);
        box-shadow: 0 20px 55px rgba(15, 23, 42, 0.92);
        overflow: hidden;
        transition: transform 0.12s ease, box-shadow 0.12s ease,
          border-color 0.12s ease;
      }

      .kpi-card::before {
        content: "";
        position: absolute;
        top: -60px;
        right: -60px;
        width: 140px;
        height: 140px;
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(129, 140, 248, 0.7),
          transparent
        );
        opacity: 0.22;
        pointer-events: none;
      }

      .kpi-card:nth-child(2)::before {
        background: radial-gradient(circle, rgba(34, 197, 94, 0.7), transparent);
      }

      .kpi-card:nth-child(3)::before {
        background: radial-gradient(circle, rgba(248, 113, 113, 0.85), transparent);
      }

      .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 26px 70px rgba(15, 23, 42, 0.95);
        border-color: rgba(129, 140, 248, 0.65);
      }

      .kpi-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }

      .kpi-value {
        font-size: 32px;
        font-weight: 700;
        line-height: 1.1;
        background: linear-gradient(
          135deg,
          #e5e7eb 0%,
          #c4b5fd 40%,
          #22d3ee 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .kpi-percent {
        margin-top: 5px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .chart-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 18px;
      }

      .chart {
        min-height: 340px;
        border-radius: 18px;
        padding: 12px 14px 10px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        box-shadow: 0 22px 65px rgba(15, 23, 42, 0.94);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        transition: transform 0.12s ease, box-shadow 0.12s ease,
          border-color 0.12s ease;
      }

      .chart:hover {
        transform: translateY(-2px);
        border-color: rgba(129, 140, 248, 0.65);
        box-shadow: 0 28px 80px rgba(15, 23, 42, 0.97);
      }

      .placeholder {
        color: var(--text-secondary);
        font-size: 14px;
        text-align: center;
        padding: 16px;
      }

      .loader {
        border: 3px solid rgba(99, 102, 241, 0.15);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 6px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @media (max-width: 1100px) {
        .filters-left {
          grid-template-columns: repeat(3, minmax(150px, 1fr));
        }
        .chart-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 900px) {
        body { padding: 16px; }
        .filters { align-items: stretch; }
        .filters-left {
          grid-template-columns: repeat(2, minmax(140px, 1fr));
        }
        .filters-right {
          width: 100%;
          align-items: stretch;
        }
        .filters button,
        #statusMessage {
          width: 100%;
          text-align: center;
        }
        .kpi-row {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        .chart-grid { grid-template-columns: 1fr; }
      }

      @media (max-width: 600px) {
        .filters-left { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>Dynamic CSAT Dashboard</h2>

      <div class="filters">
        <div class="filters-left">
          <div class="filter-field">
            <label for="startDate">Start Date:</label>
            <input type="date" id="startDate" />
          </div>
          <div class="filter-field">
            <label for="endDate">End Date:</label>
            <input type="date" id="endDate" />
          </div>
          <div class="filter-field">
            <label for="productFilter">Product:</label>
            <select id="productFilter">
              <option value="">All</option>
              <option value="CFDs">CFDs</option>
              <option value="Futures">Futures</option>
            </select>
          </div>
          <div class="filter-field">
            <label for="agentFilter">Agent:</label>
            <select id="agentFilter">
              <option value="">All Agents</option>
            </select>
          </div>
          <div class="filter-field filter-field--wide">
            <label for="categoryFilter">Drilled-in Report:</label>
            <select id="categoryFilter" onchange="refreshCategoryChart()">
              <option value="">Select categoryâ€¦</option>
            </select>
          </div>
        </div>

        <div class="filters-right">
          <button id="filterBtn" onclick="refreshDashboard()">Apply Filter</button>
          <span id="statusMessage"></span>
        </div>
      </div>

      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-label">Total CSAT Count</div>
          <div class="kpi-value" id="totalCsatCount">0</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">High CSAT Count</div>
          <div class="kpi-value" id="highCsatCount">0</div>
          <div class="kpi-percent" id="highCsatPercent"></div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Low CSAT Count</div>
          <div class="kpi-value" id="lowCsatCount">0</div>
          <div class="kpi-percent" id="lowCsatPercent"></div>
        </div>
      </div>

      <div class="chart-grid">
        <div id="csatTrendChart" class="chart">
          <div class="placeholder">Waiting for dataâ€¦</div>
        </div>
        <div id="lowRatingChart" class="chart">
          <div class="placeholder">Waiting for dataâ€¦</div>
        </div>
        <div id="topConcernsChart" class="chart">
          <div class="placeholder">Waiting for dataâ€¦</div>
        </div>
        <div id="csatFunnelChart" class="chart">
          <div class="placeholder">Waiting for dataâ€¦</div>
        </div>
        <div id="categoryPieChart" class="chart">
          <div class="placeholder">Select a category to see breakdown.</div>
        </div>
      </div>
    </div>

    <script>
      // ðŸ”— IMPORTANT: Replace this with your correct Google Apps Script Web App URL
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOymjnAZwJ676UDif1G9NnPWPEA0gTMdlunOcNosNB1Tn17oM8-XYpQ5eTbajhKC75/exec";

      const chartIds = [
        "csatTrendChart",
        "lowRatingChart",
        "topConcernsChart",
        "csatFunnelChart",
        "categoryPieChart",
      ];

      const statusEl = document.getElementById("statusMessage");
      const filterBtn = document.getElementById("filterBtn");

      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(() => {
        setDefaultDates();
        loadCategories();
        refreshDashboard();
        attachResize();
      });

      function toISO(d) {
        const tzOff = d.getTimezoneOffset();
        const local = new Date(d.getTime() - tzOff * 60000);
        return local.toISOString().slice(0, 10);
      }

      function setDefaultDates() {
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - 29);
        document.getElementById("startDate").value = toISO(start);
        document.getElementById("endDate").value = toISO(end);
      }

      function showLoading() {
        filterBtn.disabled = true;
        statusEl.innerHTML = '<span class="loader"></span> Loading dataâ€¦';

        document.getElementById("totalCsatCount").textContent = "â€¦";
        document.getElementById("highCsatCount").textContent = "â€¦";
        document.getElementById("lowCsatCount").textContent = "â€¦";
        document.getElementById("highCsatPercent").textContent = "";
        document.getElementById("lowCsatPercent").textContent = "";

        chartIds.forEach((id) => {
          const el = document.getElementById(id);
          el.innerHTML =
            '<div class="placeholder"><span class="loader"></span> Fetching dataâ€¦</div>';
        });
      }

      function setStatus(ok, msg) {
        filterBtn.disabled = false;
        statusEl.style.color = ok ? "#10b981" : "#ef4444";
        statusEl.textContent = msg;
        if (ok) setTimeout(() => (statusEl.textContent = ""), 4000);
      }

      async function refreshDashboard() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const product = document.getElementById("productFilter").value;
        const agent = document.getElementById("agentFilter").value;

        if (!startDate || !endDate) {
          setStatus(false, "Please choose both start and end dates.");
          return;
        }
        if (new Date(startDate) > new Date(endDate)) {
          setStatus(false, "Start Date must be before End Date.");
          return;
        }

        showLoading();

        const params = new URLSearchParams({
          action: "dashboard",
          startDate,
          endDate,
          product,
          agent,
        });

        try {
          const res = await fetch(`${SCRIPT_URL}?${params.toString()}`, {
            method: "GET",
            redirect: "follow"
          });

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();

          if (data.error) {
            throw new Error(data.error);
          }

          updateKPIs(data);
          drawCharts(data);
          setStatus(true, "âœ“ Dashboard loaded");

        } catch (err) {
          console.error("Dashboard error:", err);
          setStatus(false, `Dashboard failed to load: ${err.message}`);
          
          chartIds.forEach((id) => {
            document.getElementById(id).innerHTML =
              `<div class="placeholder">Error loading data. Check console for details.</div>`;
          });
        }
      }

      function updateKPIs(data) {
        document.getElementById("totalCsatCount").textContent = data.totalCsat || 0;
        document.getElementById("highCsatCount").textContent = data.highCsat || 0;
        document.getElementById("lowCsatCount").textContent = data.lowCsat || 0;

        const total = data.totalCsat || 0;
        if (total > 0) {
          const highPct = ((data.highCsat / total) * 100).toFixed(1);
          const lowPct = ((data.lowCsat / total) * 100).toFixed(1);
          document.getElementById("highCsatPercent").textContent = `${highPct}% of total`;
          document.getElementById("lowCsatPercent").textContent = `${lowPct}% of total`;
        }
      }

      function drawCharts(data) {
        if (data.trendData && data.trendData.length > 0) {
          drawTrendChart(data.trendData);
        } else {
          document.getElementById("csatTrendChart").innerHTML =
            '<div class="placeholder">No trend data available</div>';
        }

        if (data.lowRatingData && data.lowRatingData.length > 0) {
          drawLowRatingChart(data.lowRatingData);
        } else {
          document.getElementById("lowRatingChart").innerHTML =
            '<div class="placeholder">No low rating data</div>';
        }

        if (data.topConcerns && data.topConcerns.length > 0) {
          drawTopConcernsChart(data.topConcerns);
        } else {
          document.getElementById("topConcernsChart").innerHTML =
            '<div class="placeholder">No concerns data</div>';
        }

        if (data.funnelData && data.funnelData.length > 0) {
          drawFunnelChart(data.funnelData);
        } else {
          document.getElementById("csatFunnelChart").innerHTML =
            '<div class="placeholder">No funnel data</div>';
        }
      }

      function drawTrendChart(trendData) {
        const chartData = new google.visualization.DataTable();
        chartData.addColumn("string", "Date");
        chartData.addColumn("number", "High CSAT");
        chartData.addColumn("number", "Low CSAT");

        trendData.forEach((row) => {
          chartData.addRow([row.date, row.high, row.low]);
        });

        const options = {
          title: "CSAT Trend Over Time",
          backgroundColor: "transparent",
          titleTextStyle: { color: "#e5e7eb", fontSize: 16 },
          legend: { position: "bottom", textStyle: { color: "#9ca3af" } },
          hAxis: { textStyle: { color: "#9ca3af" } },
          vAxis: { textStyle: { color: "#9ca3af" } },
          colors: ["#10b981", "#ef4444"],
          chartArea: { width: "80%", height: "70%" },
        };

        const chart = new google.visualization.LineChart(
          document.getElementById("csatTrendChart")
        );
        chart.draw(chartData, options);
      }

      function drawLowRatingChart(lowRatingData) {
        const chartData = new google.visualization.DataTable();
        chartData.addColumn("string", "Reason");
        chartData.addColumn("number", "Count");

        lowRatingData.forEach((row) => {
          chartData.addRow([row.reason, row.count]);
        });

        const options = {
          title: "Low Rating Reasons",
          backgroundColor: "transparent",
          titleTextStyle: { color: "#e5e7eb", fontSize: 16 },
          legend: { position: "bottom", textStyle: { color: "#9ca3af" } },
          hAxis: { textStyle: { color: "#9ca3af" } },
          vAxis: { textStyle: { color: "#9ca3af" } },
          colors: ["#ef4444"],
          chartArea: { width: "75%", height: "70%" },
        };

        const chart = new google.visualization.BarChart(
          document.getElementById("lowRatingChart")
        );
        chart.draw(chartData, options);
      }

      function drawTopConcernsChart(topConcerns) {
        const chartData = new google.visualization.DataTable();
        chartData.addColumn("string", "Concern");
        chartData.addColumn("number", "Frequency");

        topConcerns.forEach((row) => {
          chartData.addRow([row.concern, row.count]);
        });

        const options = {
          title: "Top Customer Concerns",
          backgroundColor: "transparent",
          titleTextStyle: { color: "#e5e7eb", fontSize: 16 },
          legend: "none",
          pieSliceText: "label",
          pieSliceTextStyle: { color: "#020617", fontSize: 12 },
          chartArea: { width: "90%", height: "80%" },
        };

        const chart = new google.visualization.PieChart(
          document.getElementById("topConcernsChart")
        );
        chart.draw(chartData, options);
      }

      function drawFunnelChart(funnelData) {
        const chartData = new google.visualization.DataTable();
        chartData.addColumn("string", "Stage");
        chartData.addColumn("number", "Count");

        funnelData.forEach((row) => {
          chartData.addRow([row.stage, row.count]);
        });

        const options = {
          title: "CSAT Funnel",
          backgroundColor: "transparent",
          titleTextStyle: { color: "#e5e7eb", fontSize: 16 },
          legend: "none",
          hAxis: { textStyle: { color: "#9ca3af" } },
          vAxis: { textStyle: { color: "#9ca3af" } },
          colors: ["#6366f1"],
          chartArea: { width: "80%", height: "70%" },
        };

        const chart = new google.visualization.ColumnChart(
          document.getElementById("csatFunnelChart")
        );
        chart.draw(chartData, options);
      }

      async function loadCategories() {
        try {
          const res = await fetch(`${SCRIPT_URL}?action=categories`, {
            method: "GET",
            redirect: "follow"
          });
          
          if (!res.ok) return;
          
          const data = await res.json();
          
          if (data.categories && data.categories.length > 0) {
            const sel = document.getElementById("categoryFilter");
            data.categories.forEach((cat) => {
              const opt = document.createElement("option");
              opt.value = cat;
              opt.textContent = cat;
              sel.appendChild(opt);
            });
          }
        } catch (err) {
          console.warn("Failed to load categories:", err);
        }
      }

      async function refreshCategoryChart() {
        const category = document.getElementById("categoryFilter").value;
        const chartEl = document.getElementById("categoryPieChart");

        if (!category) {
          chartEl.innerHTML =
            '<div class="placeholder">Select a category to see breakdown.</div>';
          return;
        }

        chartEl.innerHTML =
          '<div class="placeholder"><span class="loader"></span> Loadingâ€¦</div>';

        try {
          const res = await fetch(
            `${SCRIPT_URL}?action=categoryBreakdown&category=${encodeURIComponent(category)}`,
            { method: "GET", redirect: "follow" }
          );

          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();

          if (data.error) throw new Error(data.error);

          if (data.breakdown && data.breakdown.length > 0) {
            const chartData = new google.visualization.DataTable();
            chartData.addColumn("string", "Subcategory");
            chartData.addColumn("number", "Count");

            data.breakdown.forEach((row) => {
              chartData.addRow([row.subcategory, row.count]);
            });

            const options = {
              title: `${category} Breakdown`,
              backgroundColor: "transparent",
              titleTextStyle: { color: "#e5e7eb", fontSize: 16 },
              legend: { position: "bottom", textStyle: { color: "#9ca3af" } },
              pieSliceText: "value",
              pieSliceTextStyle: { color: "#020617", fontSize: 12 },
              chartArea: { width: "90%", height: "75%" },
            };

            const chart = new google.visualization.PieChart(chartEl);
            chart.draw(chartData, options);
          } else {
            chartEl.innerHTML = '<div class="placeholder">No data for this category</div>';
          }
        } catch (err) {
          console.error("Category chart error:", err);
          chartEl.innerHTML =
            `<div class="placeholder">Error: ${err.message}</div>`;
        }
      }

      function attachResize() {
        let timeout;
        window.addEventListener("resize", () => {
          clearTimeout(timeout);
          timeout = setTimeout(() => {
            refreshDashboard();
          }, 300);
        });
      }
    </script>
  </body>
</html>
